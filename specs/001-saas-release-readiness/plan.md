# Implementation Plan: SaaS Release Readiness

**Branch**: `001-saas-release-readiness` | **Date**: 2025-12-01 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/001-saas-release-readiness/spec.md`

**Note**: This document outlines the technical approach and implementation strategy for making YOU+ production-ready for SaaS release.

## Summary

YOU+ is a voice-first accountability app powered by AI that makes nightly calls to users. The core backend (Cloudflare Workers) and mobile app exist, but the web platform lacks critical SaaS infrastructure: web authentication UI, checkout/billing pages, account settings, legal pages, and transactional email. This plan covers implementing the complete user lifecycle on the web platform: signup → trial → payment → account management.

## Technical Context

**Language/Version**: TypeScript 5.3+ (Next.js 16), Node.js 20+  
**Primary Dependencies**: 
  - Frontend: Next.js 16, React 19, Tailwind CSS, Lucide icons
  - Backend (existing): Cloudflare Workers, Hono 4, Supabase, OpenAI, ElevenLabs
  
**Storage**: Supabase (PostgreSQL) with RLS policies  
**Testing**: Jest (unit/integration), Playwright (E2E for critical paths)  
**Target Platform**: Web browser (responsive), Production (Vercel + Cloudflare Workers)  
**Project Type**: Web application with backend API  
**Performance Goals**: 
  - Signup-to-dashboard: <3 minutes
  - Password reset email: <2 minutes delivery, 99% success rate
  - Payment form: <500ms p95 latency
  
**Constraints**: 
  - <3MB initial page size for landing page
  - Support mobile browsers (iOS Safari, Chrome)
  - GDPR/CCPA compliant data handling
  
**Scale/Scope**: MVP launch (~50k users in year 1), then scale to 500k+

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Principle I: Subscription-First Security

**Status**: ✅ PASS (with implementation requirement)

- All feature endpoints will be gated behind `requireActiveSubscription` middleware
- Public endpoints limited to: health checks, webhooks, and authentication flows
- Paywall returns 402 with `redirectToPaywall` directive
- **Implementation note**: Trial users will bypass subscription check for first 7 days; detection based on `trial_started` timestamp

### Principle II: Timezone-Aware Scheduling

**Status**: ✅ PASS (not directly applicable but supported)

- This feature focuses on auth/billing, not call scheduling
- User timezone preference stored during signup (optional, defaults to UTC)
- Future call scheduling will use this preference
- No conflicts with existing architecture

### Principle III: Test-First for Critical Paths

**Status**: ⚠️ CONDITIONAL PASS (requires integration tests)

- Critical paths: signup → dashboard, login, password reset, payment
- All critical paths MUST have integration tests written before implementation
- Red-Green-Refactor cycle mandatory for any bugs in auth flows
- **Note**: Unit tests for utilities are optional; integration tests are mandatory

### Principle IV: Graceful Degradation

**Status**: ✅ PASS (with patterns documented)

- Payment provider downtime: graceful error with retry mechanism
- Email service downtime: queue system with exponential backoff
- Auth provider (Supabase) downtime: fallback error page, graceful logout
- Frontend gracefully handles API failures without data loss

### Principle V: Observability & Auditability

**Status**: ✅ PASS (logging infrastructure required)

- All auth attempts logged with timestamp, email, success/failure, IP
- Sensitive data excluded: passwords never logged, only hashed
- Payment events logged: attempt, result, card fingerprint (not full number)
- Call to external services logged with request/response metadata
- **No action required**: Existing Cloudflare Workers logging will capture backend

**Gate Result**: ✅ ALL GATES PASS

No unjustified violations. Implementation can proceed with test-first discipline.

## Project Structure

### Documentation (this feature)

```text
specs/001-saas-release-readiness/
├── plan.md              # This file
├── research.md          # Phase 0: Research & design decisions
├── data-model.md        # Phase 1: Database schema & entities
├── contracts/           # Phase 1: API contracts (OpenAPI/GraphQL)
│   ├── auth.yaml
│   ├── billing.yaml
│   └── account.yaml
├── quickstart.md        # Phase 1: Developer quick start
└── tasks.md             # Phase 2: Implementation tasks (generated by /speckit.tasks)
```

### Source Code (web application)

```text
web/
├── src/
│   ├── app/
│   │   ├── auth/                    # NEW: Auth pages
│   │   │   ├── login/page.tsx
│   │   │   ├── signup/page.tsx
│   │   │   └── reset-password/page.tsx
│   │   ├── account/                 # NEW: Account settings
│   │   │   ├── settings/page.tsx
│   │   │   ├── billing/page.tsx
│   │   │   └── subscription/page.tsx
│   │   ├── legal/                   # NEW: Legal pages
│   │   │   ├── terms/page.tsx
│   │   │   └── privacy/page.tsx
│   │   ├── checkout/page.tsx        # NEW: Payment checkout
│   │   ├── dashboard/page.tsx       # MODIFIED: Add paywall guard
│   │   ├── onboarding/page.tsx      # MODIFIED: Move after signup
│   │   ├── call/page.tsx
│   │   ├── layout.tsx               # MODIFIED: Add auth context provider
│   │   └── page.tsx                 # MODIFIED: Add login link to nav
│   ├── components/
│   │   ├── auth/                    # NEW
│   │   │   ├── LoginForm.tsx
│   │   │   ├── SignupForm.tsx
│   │   │   └── ResetPasswordForm.tsx
│   │   ├── billing/                 # NEW
│   │   │   ├── PaymentForm.tsx
│   │   │   ├── BillingHistory.tsx
│   │   │   └── SubscriptionStatus.tsx
│   │   ├── legal/                   # NEW
│   │   │   ├── TermsOfService.tsx
│   │   │   └── PrivacyPolicy.tsx
│   │   └── shared/                  # NEW
│   │       ├── Paywall.tsx
│   │       └── AuthGuard.tsx
│   ├── services/
│   │   ├── api.ts                   # MODIFIED: Add auth endpoints
│   │   ├── auth.ts                  # NEW: Auth service
│   │   ├── payment.ts               # NEW: Payment service
│   │   └── email.ts                 # NEW: Email service reference
│   ├── hooks/
│   │   ├── useAuth.ts               # NEW: Auth context hook
│   │   ├── useSubscription.ts       # NEW: Subscription status hook
│   │   └── usePayment.ts            # NEW: Payment flow hook
│   └── types.ts                     # MODIFIED: Add auth/billing types
└── tests/
    ├── integration/
    │   ├── auth.test.ts             # NEW
    │   ├── payment.test.ts          # NEW
    │   └── subscription.test.ts     # NEW
    └── unit/
        ├── forms.test.ts            # NEW
        └── validation.test.ts       # NEW

old-backend-for-swift/ (Cloudflare Workers)
├── src/
│   ├── routes/
│   │   ├── auth.ts                  # NEW: Auth endpoints
│   │   ├── billing.ts               # MODIFIED: Expand from existing
│   │   └── account.ts               # NEW: Account management
│   └── services/
│       ├── email-service.ts         # NEW: Transactional email
│       └── payment-service.ts       # NEW: RevenueCat wrapper
└── tests/
    ├── auth.test.ts                 # NEW
    └── billing.test.ts              # NEW
```

**Structure Decision**: Web application (Option 2) with separate frontend (Next.js) and backend (Cloudflare Workers). Auth is split between frontend (UI/forms) and backend (JWT validation, session management). Payments leverage existing RevenueCat infrastructure in backend.

## Complexity Tracking

No violations or exceptions. Implementation follows all constitution principles and standard architecture patterns. Test-First discipline required (Principle III) but is standard practice for auth/payment flows.

---

## Phase 0: Research & Architecture Decisions

**Status**: ✅ COMPLETE (with Phase 2 TODO)

### Key Decisions Made

1. **Email Service**: ✅ Resend (TypeScript-native, Next.js optimized)
   - Documented in research.md

2. **Payment UI**: ✅ RevenueCat hosted paywall (no PCI scope, webhook-driven)
   - Documented in research.md

3. **Session Management**: ✅ JWT + HTTP-only cookies (stateless backend, XSS protection)
   - Documented in research.md

4. **Web Call Delivery**: ⏭️ **Phase 2 TODO** - Implement direct phone call delivery
   - Current state: Mobile uses push/VoIP, web has no call mechanism
   - Next: Design direct phone call flow for web users (outside SaaS MVP scope)
   - Will be tackled in Phase 2 after auth/billing foundation

## Phase 1: Design & Contracts

**Prerequisites**: Phase 0 research.md complete

**Deliverables**:
- data-model.md: Supabase schema for auth/subscription/trials
- /contracts/auth.yaml: Login, signup, password reset endpoints
- /contracts/billing.yaml: Subscription, payment, cancellation endpoints
- /contracts/account.yaml: Settings, profile, billing history endpoints
- quickstart.md: Developer guide for local setup and testing

**Key Design Decisions**:
- Auth: Supabase Auth provider (existing) with custom claims for trial status
- Trials: Track trial_start_date and trial_end_date in users table
- Email: Async queue pattern (store, send, retry on failure)
- Payment: Wrap RevenueCat SDK in service layer for consistency
- **Calls**: Deferred to Phase 2 (direct phone call delivery for web, design pending)

---

## Implementation Strategy

### Phased Rollout

**MVP (Phase 1)**: P1 user stories only
- Signup with email/password
- Login/logout
- Forgotten password reset
- Trial-to-paid workflow (manual for MVP)
- Paywall for expired trials

**v1.1 (Phase 2)**: P2 user stories
- Account settings page
- Subscription management
- Billing history
- Cancel subscription

**v1.2 (Phase 3)**: Operations
- Error monitoring & alerts
- Email delivery dashboard
- Admin tools for troubleshooting

### Risk Mitigation

| Risk | Mitigation |
|------|-----------|
| Payment failures | RevenueCat handles retries; graceful UI fallback |
| Auth downtime (Supabase) | Cache session in localStorage; clear on error |
| Email delivery latency | Queue system with 24h retry, user can resend |
| Data loss during migration | No data migration needed; new tables for auth/trials |

---
